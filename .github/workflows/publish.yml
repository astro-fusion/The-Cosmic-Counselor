name: Publish Multilingual Quarto Book

on:
  push:
    branches: [main]
    paths:
      - '*.qmd'
      - '**/*.qmd'
      - '_quarto.yml'
      - 'translations/**'
      - 'styles/**'
      - 'scripts/**'
  workflow_dispatch:

jobs:
  build-multilingual-html:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Build English version
        run: quarto render --to html

      - name: Build Hindi version
        run: quarto render --project translations/hi/_quarto.yml --to html

      - name: Build Nepali version
        run: quarto render --project translations/ne/_quarto.yml --to html

      - name: Debug - List generated files
        run: |
          echo "Contents of _book directory:"
          ls -la _book/
          echo "Contents of _book/hi directory:"
          ls -la _book/hi/ || echo "Hindi directory not found"
          echo "Contents of _book/ne directory:"
          ls -la _book/ne/ || echo "Nepali directory not found"

      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./_book
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  build-multilingual-formats:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        with:
          tinytex: true

      - name: Build English formats
        run: |
          quarto render --to pdf
          quarto render --to epub

      - name: Build Hindi formats
        run: |
          quarto render --project translations/hi/_quarto.yml --to pdf
          quarto render --project translations/hi/_quarto.yml --to epub

      - name: Build Nepali formats
        run: |
          quarto render --project translations/ne/_quarto.yml --to pdf
          quarto render --project translations/ne/_quarto.yml --to epub

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: ncipollo/release-action@v1
        with:
          tag: release-${{ steps.date.outputs.date }}
          name: Multilingual Book Release ${{ steps.date.outputs.date }}
          body: |
            📚 **The Cosmic Counselor** - Multilingual Release
            
            **🌍 Available Languages:**
            
            🇺🇸 **English**
            - 🌐 [HTML Version](https://astro-fusion.github.io/The-Cosmic-Counselor)
            - 📄 PDF: Download below
            - 📱 EPUB: Download below
            
            🇮🇳 **Hindi (हिंदी)**
            - 🌐 [HTML Version](https://astro-fusion.github.io/The-Cosmic-Counselor/hi)
            - 📄 PDF: Download below
            - 📱 EPUB: Download below
            
            🇳🇵 **Nepali (नेपाली)**
            - 🌐 [HTML Version](https://astro-fusion.github.io/The-Cosmic-Counselor/ne)
            - 📄 PDF: Download below
            - 📱 EPUB: Download below
            
            Generated on: ${{ steps.date.outputs.date }}
          artifacts: |
            _book/The-Cosmic-Counselor.pdf
            _book/The-Cosmic-Counselor.epub
            _book/hi/The-Cosmic-Counselor.pdf
            _book/hi/The-Cosmic-Counselor.epub
            _book/ne/The-Cosmic-Counselor.pdf
            _book/ne/The-Cosmic-Counselor.epub
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}
